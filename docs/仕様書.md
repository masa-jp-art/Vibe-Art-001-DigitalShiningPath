# デジタル・シャイニングパス：実装仕様書

本書は、少人数参加者の**電子シミュレーション**と、実参加者向けの**本番運用**を同一パイプに乗せるための技術仕様を定義します。

## 1. 目的 / 非目的
- **目的**：参加者の語り（記憶・夢・感情）を材料に、  
  1) 神話的物語（TXT/朗読）、2) 内観図（PNG）、3) 音響（WAV/MP3）、4) 体験ページ（HTML）を生成・納品する  
- **非目的**：心理療法/医療的診断・治療の提供、宗教的教義の提示、個人情報の不要な収集

## 2. 成果物（出力仕様）
- **体験ページ**：`index.html`（参加者別ページ + 総合インデックス）
- **画像**：`mandala.png`（推奨A3印刷 300dpi / 正方形 3000px 以上）
- **音響**：
  - 制作マスター：`ambient.wav`（Mono, 44.1kHz, 16bit, 120–300秒）
  - 配信用：`ambient.mp3`（CBR/ABR 192kbps 推奨）
- **テキスト**：`story.txt`（1200–1800字、2人称・祝詞調）

## 3. 非機能要件
- **再現性**：同一シードで同一画像・音響を再生成可能  
- **可搬性**：ローカル/展示PC/配信用サーバで動作  
- **安全性**：個人特定情報の**分離・最小化・削除要請対応**  
- **アクセシビリティ**：体験ページは1ファイルで主要ブラウザ再生可（MP3→WAVのフォールバック）

## 4. アーキテクチャ概要
入力（フォーム/音声/日記）
└─ 整形：episodes.json（タグ/象徴/強度）
└─ LLM要約・神話化
├─ 物語TXT
├─ 画像PNG（曼荼羅）
├─ 音響WAV→MP3
└─ 体験HTML（画像/音響/物語を束ねる）
└─ 納品（MP4/PDFは任意で派生）


## 5. データモデル（episodes.json）
```json
{
  "participant_id": "p01",
  "episodes": [{
    "id": "p01_20250811_01",
    "timestamp": "2025-08-11T10:21:00+09:00",
    "type": "memory | dream | emotion | symbol",
    "title": "夏の雨と祖母の台所",
    "text": "本人の語り原文。",
    "quotes": ["短い直引用", "...", "..."],
    "emotions": {"primary": "nostalgia", "intensity": 0.7},
    "symbols": ["雨", "台所", "包丁"],
    "keywords": ["雨音", "薄荷", "帰路"],
    "consent_scope": "art_only | research_ok",
    "redact": false,
    "notes": ""
  }]
}

## 6. 生成パイプライン仕様
### 6.1 テキスト（神話的物語）
- 構成：召喚 → 通過 → 授与 → 帰還
- 制約：直引用3箇所／固有名詞2箇所／象徴3種以上（反復を3回以上）

### 6.2 画像（曼荼羅）
- 入力：keywords と symbols
- 描画：同心円・放射・螺旋・象徴オーバーレイ（雨/電車/灯台など）
- 出力：mandala.png（3000×3000px 推奨）

### 6.3 音響（アンビエント）
- 120–300秒、ドローン主体（根音＋5度＋3度）、緩いトレモロ
- 小ベル／微細ノイズ（任意）、フェードイン/アウト
- レベル目安：-14〜-16 LUFS

### 6.4 体験ページ（HTML）
- 構成：タイトル／曼荼羅／物語／オーディオ／キーワード／象徴／簡易瞑想ガイド
- オーディオ：
<audio controls preload="auto" style="width:100%">
  <source src="ambient.mp3" type="audio/mpeg">
  <source src="ambient.wav" type="audio/wav">
</audio>

## 7. セーフティ / プライバシー
- 最小収集、削除請求対応、公開版の匿名化、感情負荷への配慮（セーフワード/中断手順）

## 8. 品質ゲート
- 直引用≥3／反復モチーフ≥3／断定回避（解釈の余白）
- 音量/フラッシュ基準を満たす
- A3印刷で可読性良好
- 主要ブラウザで再生確認（MP3→WAVフォールバック）

## 付録：コマンド例
python tools/simulate.py --participants 3 --out ./DSP_Sim
python tools/export_mp3.py --root ./DSP_Sim --bitrate 192k
